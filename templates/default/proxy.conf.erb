<%
node['nginx']['proxy']['cache']['proxy_cache_path'].each do |path|
  path_string='proxy_cache_path'
  path_string+=" #{ path.first}"
  path.last.each do |k,v|
    path_string+=" #{k}=#{v}"
  end %>
<%=path_string%>;
<%end%>

proxy_cache_key "$scheme$request_method$host$request_uri";

server {
    # Note that it's listening on port 80
    listen 80 default_server;
    root /var/www/;
    index index.html index.htm;

    server_name example.com www.example.com;

    charset utf-8;
<% @proxy_hash['location'].each do |location| %>
    location <%= location.first %> {
        <% if @proxy_hash['cache_enable'] %>
        proxy_cache <%= node['nginx']['proxy']['cache']['proxy_cache_path'][location.last['proxy_cache_path']]['keys_zone'].split(':').first %>;
        <% end %>
        add_header X-Proxy-Cache $upstream_cache_status;

        include proxy_params;
        proxy_pass <%= location.last['proxy_pass'] %>;
    }
}
<% end %>
